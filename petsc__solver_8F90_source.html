<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MONC: components/petsc_solver/src/petsc_solver.F90 Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MONC
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_409f97388efe006bc3438b95e9edef48.html">components</a></li><li class="navelem"><a class="el" href="dir_d672671f718e5f1bc0484134bd5a3595.html">petsc_solver</a></li><li class="navelem"><a class="el" href="dir_f8c5dc1e9bd559bdcb7ff0dd2836a0da.html">src</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">petsc_solver.F90</div>  </div>
</div><!--header-->
<div class="contents">
<a href="petsc__solver_8F90.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160; </div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="preprocessor">#include &quot;petsc/finclude/petscvecdef.h&quot;</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#include &quot;petsc/finclude/petscmatdef.h&quot;</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#include &quot;petsc/finclude/petsckspdef.h&quot;</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#include &quot;petsc/finclude/petscdmdadef.h&quot;</span></div>
<div class="line"><a name="l00006"></a><span class="lineno"><a class="line" href="namespacepetsc__solver__mod.html">    6</a></span>&#160;<span class="preprocessor"></span><span class="keyword">module</span> <a class="code" href="namespacepetsc__solver__mod.html">petsc_solver_mod</a></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;  <span class="keywordtype">use </span><a class="code" href="namespacedatadefn__mod.html">datadefn_mod</a>, <span class="keywordtype">only</span> : <a class="code" href="namespacedatadefn__mod.html#a39b79f8cc843d236d3b47f5c81b64368">default_precision</a>, <a class="code" href="namespacedatadefn__mod.html#a9e9ab0279f2158e1e0e259259f014bd1">string_length</a></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;  <span class="keywordtype">use </span><a class="code" href="namespacestate__mod.html">state_mod</a>, <span class="keywordtype">only</span> : <a class="code" href="structstate__mod_1_1model__state__type.html">model_state_type</a></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;  <span class="keywordtype">use </span><a class="code" href="namespacemonc__component__mod.html">monc_component_mod</a>, <span class="keywordtype">only</span> : <a class="code" href="structmonc__component__mod_1_1component__descriptor__type.html">component_descriptor_type</a></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;  <span class="keywordtype">use </span><a class="code" href="namespacegrids__mod.html">grids_mod</a>, <span class="keywordtype">only</span> : <a class="code" href="structgrids__mod_1_1local__grid__type.html">local_grid_type</a>, <a class="code" href="namespacegrids__mod.html#ab478bbfee0dae6b2e13f3a5eb85be214">x_index</a>, <a class="code" href="namespacegrids__mod.html#aa0e3f2f5767ed33c4b47a761c2af171a">y_index</a>, <a class="code" href="namespacegrids__mod.html#aa1eee0ed41ef0446ae1a6155b78a2239">z_index</a></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;  <span class="keywordtype">use </span><a class="code" href="namespacelogging__mod.html">logging_mod</a>, <span class="keywordtype">only</span> : <a class="code" href="namespacelogging__mod.html#aca1c925af27b4d533d548bfe69a819f3">log_debug</a>, <a class="code" href="namespacelogging__mod.html#ac7d5c1fcb00d54277580c10556aa78a8">log_info</a>, <a class="code" href="namespacelogging__mod.html#ad68309846cd8f9e77edaa6abd02f65a0">log_error</a>, <a class="code" href="namespacelogging__mod.html#ac4f13ac385499c85190cb184030e4f45">log_log</a>, <a class="code" href="namespacelogging__mod.html#ad95937a250467334622daeb5cff78c20">log_master_log</a>, <a class="code" href="namespacelogging__mod.html#ae0d255e756059bc76b2f4291825e59c9">log_get_logging_level</a>, <a class="code" href="namespacelogging__mod.html#aa7d08e4de819bf03922844a8366c28ae">log_is_master</a></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;  <span class="keywordtype">use </span><a class="code" href="namespaceoptionsdatabase__mod.html">optionsdatabase_mod</a>, <span class="keywordtype">only</span> : <a class="code" href="namespaceoptionsdatabase__mod.html#ae6f0a2a95fcacd3491b7b8fdb161e022">options_get_integer</a>, <a class="code" href="namespaceoptionsdatabase__mod.html#ab054641ac0fa0287adb3c461987c4f0b">options_get_real</a>, <a class="code" href="namespaceoptionsdatabase__mod.html#af2aeb42c9fdb961702216042b0330088">options_get_string</a></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;  <span class="keywordtype">use </span><a class="code" href="namespaceconversions__mod.html">conversions_mod</a>, <span class="keywordtype">only</span> : <a class="code" href="interfaceconversions__mod_1_1conv__to__string.html">conv_to_string</a></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;  <span class="keywordtype">use </span><a class="code" href="namespacecommunication__types__mod.html">communication_types_mod</a>, <span class="keywordtype">only</span> : <a class="code" href="structcommunication__types__mod_1_1halo__communication__type.html">halo_communication_type</a>, <a class="code" href="structcommunication__types__mod_1_1neighbour__description__type.html">neighbour_description_type</a>, <a class="code" href="structcommunication__types__mod_1_1field__data__wrapper__type.html">field_data_wrapper_type</a></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;  <span class="keywordtype">use </span><a class="code" href="namespacehalo__communication__mod.html">halo_communication_mod</a>, <span class="keywordtype">only</span> : <a class="code" href="namespacehalo__communication__mod.html#af69a6efcccb7091a6735135bb468c765">copy_buffer_to_field</a>, <a class="code" href="namespacehalo__communication__mod.html#a213c2f386f6a61af7053b74d9c3babbb">copy_field_to_buffer</a>, <a class="code" href="namespacehalo__communication__mod.html#a2eba69a892b0533614ecccad674e61ed">perform_local_data_copy_for_field</a>, &amp;</div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;       <a class="code" href="namespacehalo__communication__mod.html#ac287e4b520fd9a75f35e58e67ec52880">init_halo_communication</a>, <a class="code" href="namespacehalo__communication__mod.html#a9f9daddadb8276b6a0d2d13e2e8ce1d5">finalise_halo_communication</a>, <a class="code" href="namespacehalo__communication__mod.html#a0a11eeeaa1e80eab180fb8652ce592a6">blocking_halo_swap</a>, <a class="code" href="namespacehalo__communication__mod.html#aaff14692e79ef19796f8c6af98bc6ef9">get_single_field_per_halo_cell</a></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;  <span class="keywordtype">use </span>petscvec</div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;  <span class="keywordtype">use </span>petscmat</div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;  <span class="keywordtype">use </span>petscksp</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;  <span class="keywordtype">use </span>petscsys</div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;  <span class="keywordtype">use </span>petscdmda</div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;  <span class="keywordtype">implicit none</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160; </div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="preprocessor">#ifndef TEST_MODE</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="preprocessor"></span>  <span class="keywordtype">private</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="preprocessor"></span> </div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;  ksp :: ksp</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;  dm :: da</div>
<div class="line"><a name="l00030"></a><span class="lineno"><a class="line" href="namespacepetsc__solver__mod.html#ad3c6adbda077c8f90dbd9aae609409a8">   30</a></span>&#160;  <span class="keywordtype">integer</span> :: <a class="code" href="namespacepetsc__solver__mod.html#ad3c6adbda077c8f90dbd9aae609409a8">z_start</a>, <a class="code" href="namespacepetsc__solver__mod.html#a46c7d73ab716ad3f636d6f06dc2d16cf">z_end</a>, <a class="code" href="namespacepetsc__solver__mod.html#a457ff5121ab099abe67e465d171fe19d">y_start</a>, <a class="code" href="namespacepetsc__solver__mod.html#ae0e6042016d5ce258a542b35adc00e5a">y_end</a>, <a class="code" href="namespacepetsc__solver__mod.html#a54b3a29d4b49d4b28f58a359469a948f">x_start</a>, <a class="code" href="namespacepetsc__solver__mod.html#a56796946283179e75de58fe7a375e28a">x_end</a></div>
<div class="line"><a name="l00031"></a><span class="lineno"><a class="line" href="namespacepetsc__solver__mod.html#ad9fc72a089d8e1881e7bc8f9bd6e542d">   31</a></span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structcommunication__types__mod_1_1halo__communication__type.html">halo_communication_type</a>), <span class="keywordtype">save</span> :: <a class="code" href="namespacepetsc__solver__mod.html#ad9fc72a089d8e1881e7bc8f9bd6e542d">halo_swap_state</a></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160; </div>
<div class="line"><a name="l00033"></a><span class="lineno"><a class="line" href="namespacepetsc__solver__mod.html#a05bacf56df2bbcbc3ab21d47e759cec7">   33</a></span>&#160;<span class="keywordtype">  real</span>(kind=<a class="code" href="namespacedatadefn__mod.html#a39b79f8cc843d236d3b47f5c81b64368">default_precision</a>), <span class="keywordtype">dimension(:,:,:)</span>, <span class="keywordtype">allocatable</span> :: <a class="code" href="namespacepetsc__solver__mod.html#a48dcc2baf3f3d5edbab576fc380701b5">p_source</a>, <a class="code" href="namespacepetsc__solver__mod.html#a05bacf56df2bbcbc3ab21d47e759cec7">prev_p</a></div>
<div class="line"><a name="l00034"></a><span class="lineno"><a class="line" href="namespacepetsc__solver__mod.html#af7909ed04090b3bfffd7d5fc33539fcd">   34</a></span>&#160;<span class="keywordtype">  real</span>(kind=<a class="code" href="namespacedatadefn__mod.html#a39b79f8cc843d236d3b47f5c81b64368">default_precision</a>) :: <a class="code" href="namespacepetsc__solver__mod.html#a3b8f52c1847557fab15749c1b514971c">cx</a>, <a class="code" href="namespacepetsc__solver__mod.html#af7909ed04090b3bfffd7d5fc33539fcd">cy</a></div>
<div class="line"><a name="l00035"></a><span class="lineno"><a class="line" href="namespacepetsc__solver__mod.html#a5c58b8b99675ab89fa495a8cd74f5325">   35</a></span>&#160;<span class="keywordtype">  real</span>(kind=<a class="code" href="namespacedatadefn__mod.html#a39b79f8cc843d236d3b47f5c81b64368">default_precision</a>), <span class="keywordtype">dimension(:)</span>, <span class="keywordtype">allocatable</span> :: <a class="code" href="namespacepetsc__solver__mod.html#a0726b9beb4039fc34bccbaaf0318f0b3">rdzn</a>, <a class="code" href="namespacepetsc__solver__mod.html#a9a2540e20466327134ce888b965f3c08">rdz</a>, <a class="code" href="namespacepetsc__solver__mod.html#a9b84c80ea5d7755ddbab62600239d8dd">rho</a>, <a class="code" href="namespacepetsc__solver__mod.html#a5c58b8b99675ab89fa495a8cd74f5325">rhon</a>, <a class="code" href="namespacepetsc__solver__mod.html#abb609729a980841b02373e46e40de705">dz</a>, <a class="code" href="namespacepetsc__solver__mod.html#a529b7788cbcf56a4b00add8b23179d34">dzn</a></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160; </div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;  <span class="keywordtype">public</span> <a class="code" href="namespacepetsc__solver__mod.html#a451a0b7c857bd1c9a88afcb53784952a">petsc_solver_get_descriptor</a></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160; </div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;  <span class="keyword">contains</span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160; </div>
<div class="line"><a name="l00043"></a><span class="lineno"><a class="line" href="namespacepetsc__solver__mod.html#a451a0b7c857bd1c9a88afcb53784952a">   43</a></span>&#160;  <span class="keywordtype">type</span>(<a class="code" href="structmonc__component__mod_1_1component__descriptor__type.html">component_descriptor_type</a>) function <a class="code" href="namespacepetsc__solver__mod.html#a451a0b7c857bd1c9a88afcb53784952a">petsc_solver_get_descriptor</a>()</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;    <a class="code" href="namespacepetsc__solver__mod.html#a451a0b7c857bd1c9a88afcb53784952a">petsc_solver_get_descriptor</a>%name=<span class="stringliteral">&quot;petsc_solver&quot;</span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;    <a class="code" href="namespacepetsc__solver__mod.html#a451a0b7c857bd1c9a88afcb53784952a">petsc_solver_get_descriptor</a>%version=0.1</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;    <a class="code" href="namespacepetsc__solver__mod.html#a451a0b7c857bd1c9a88afcb53784952a">petsc_solver_get_descriptor</a>%initialisation=&gt;<a class="code" href="namespacepetsc__solver__mod.html#adf2548341733155ba725373a96aef324">init_callback</a></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;    <a class="code" href="namespacepetsc__solver__mod.html#a451a0b7c857bd1c9a88afcb53784952a">petsc_solver_get_descriptor</a>%timestep=&gt;<a class="code" href="namespacepetsc__solver__mod.html#a33751edb5b5265c8753e6034a62a15f4">timestep_callback</a></div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;    <a class="code" href="namespacepetsc__solver__mod.html#a451a0b7c857bd1c9a88afcb53784952a">petsc_solver_get_descriptor</a>%finalisation=&gt;<a class="code" href="namespacepetsc__solver__mod.html#ab16254aead68a763822c781f41feccf6">finalisation_callback</a></div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;  <span class="keyword">end function </span><a class="code" href="namespacepetsc__solver__mod.html#a451a0b7c857bd1c9a88afcb53784952a">petsc_solver_get_descriptor</a></div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160; </div>
<div class="line"><a name="l00051"></a><span class="lineno"><a class="line" href="namespacepetsc__solver__mod.html#ab16254aead68a763822c781f41feccf6">   51</a></span>&#160; <span class="keyword">subroutine </span><a class="code" href="namespacepetsc__solver__mod.html#ab16254aead68a763822c781f41feccf6">finalisation_callback</a>(current_state)</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;    <span class="keywordtype">type</span>(model_state_type), <span class="keywordtype">target</span>, <span class="keywordtype">intent(inout)</span> :: current_state</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160; </div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;    petscerrorcode :: ierr</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160; </div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;    <span class="keyword">call </span>petscfinalize(ierr)</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;  <span class="keyword">end subroutine </span><a class="code" href="namespacepetsc__solver__mod.html#ab16254aead68a763822c781f41feccf6">finalisation_callback</a>  </div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160; </div>
<div class="line"><a name="l00062"></a><span class="lineno"><a class="line" href="namespacepetsc__solver__mod.html#adf2548341733155ba725373a96aef324">   62</a></span>&#160;  <span class="keyword">subroutine </span><a class="code" href="namespacepetsc__solver__mod.html#adf2548341733155ba725373a96aef324">init_callback</a>(current_state)</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;    <span class="keywordtype">type</span>(model_state_type), <span class="keywordtype">target</span>, <span class="keywordtype">intent(inout)</span> :: current_state</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160; </div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    petscerrorcode :: ierr</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;    ksptype :: ksp_type</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;    pc :: pc_instance</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    pctype :: pc_type</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;    <span class="keywordtype">integer</span> :: y_lengths(current_state%parallel%dim_sizes(Y_INDEX)), x_lengths(current_state%parallel%dim_sizes(X_INDEX))</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;    <span class="keywordtype">integer</span> new_communicator, my_transposed_rank, x_rank_val, y_rank_val</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160; </div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;    <span class="keyword">call </span><a class="code" href="namespacepetsc__solver__mod.html#a7a134894de62b094c42364e7ccfaba02">apply_dimension_bounds</a>(current_state%global_grid%size(y_index), current_state%parallel%dim_sizes(y_index), y_lengths)</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;    <span class="keyword">call </span><a class="code" href="namespacepetsc__solver__mod.html#a7a134894de62b094c42364e7ccfaba02">apply_dimension_bounds</a>(current_state%global_grid%size(x_index), current_state%parallel%dim_sizes(x_index), x_lengths)</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160; </div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;    <span class="keyword">allocate</span>(<a class="code" href="namespacepetsc__solver__mod.html#a48dcc2baf3f3d5edbab576fc380701b5">p_source</a>(current_state%local_grid%size(z_index)-1, current_state%local_grid%size(y_index), &amp;</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;         current_state%local_grid%size(x_index)), <a class="code" href="namespacepetsc__solver__mod.html#a05bacf56df2bbcbc3ab21d47e759cec7">prev_p</a>(current_state%local_grid%size(z_index)-1, &amp;</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;         current_state%local_grid%size(y_index), current_state%local_grid%size(x_index)))</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160; </div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;    <a class="code" href="namespacepetsc__solver__mod.html#a3b8f52c1847557fab15749c1b514971c">cx</a>=current_state%global_grid%configuration%horizontal%cx</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;    <a class="code" href="namespacepetsc__solver__mod.html#af7909ed04090b3bfffd7d5fc33539fcd">cy</a>=current_state%global_grid%configuration%horizontal%cy</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;    <span class="keyword">allocate</span>(<a class="code" href="namespacepetsc__solver__mod.html#a0726b9beb4039fc34bccbaaf0318f0b3">rdzn</a>(current_state%local_grid%size(z_index)-1), <a class="code" href="namespacepetsc__solver__mod.html#a9a2540e20466327134ce888b965f3c08">rdz</a>(current_state%local_grid%size(z_index)-1), &amp;</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;         <a class="code" href="namespacepetsc__solver__mod.html#a9b84c80ea5d7755ddbab62600239d8dd">rho</a>(current_state%local_grid%size(z_index)-1), <a class="code" href="namespacepetsc__solver__mod.html#a5c58b8b99675ab89fa495a8cd74f5325">rhon</a>(current_state%local_grid%size(z_index)-1), &amp;</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;         <a class="code" href="namespacepetsc__solver__mod.html#abb609729a980841b02373e46e40de705">dz</a>(current_state%local_grid%size(z_index)-1), <a class="code" href="namespacepetsc__solver__mod.html#a529b7788cbcf56a4b00add8b23179d34">dzn</a>(current_state%local_grid%size(z_index)-1))</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;    <a class="code" href="namespacepetsc__solver__mod.html#a0726b9beb4039fc34bccbaaf0318f0b3">rdzn</a>=current_state%global_grid%configuration%vertical%rdzn(2:)</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;    <a class="code" href="namespacepetsc__solver__mod.html#a9a2540e20466327134ce888b965f3c08">rdz</a>=current_state%global_grid%configuration%vertical%rdz(2:)</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;    <a class="code" href="namespacepetsc__solver__mod.html#a9b84c80ea5d7755ddbab62600239d8dd">rho</a>=current_state%global_grid%configuration%vertical%rho(2:)</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;    <a class="code" href="namespacepetsc__solver__mod.html#a5c58b8b99675ab89fa495a8cd74f5325">rhon</a>=current_state%global_grid%configuration%vertical%rhon(2:)</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;    <a class="code" href="namespacepetsc__solver__mod.html#abb609729a980841b02373e46e40de705">dz</a>=current_state%global_grid%configuration%vertical%dz(2:)</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;    <a class="code" href="namespacepetsc__solver__mod.html#a529b7788cbcf56a4b00add8b23179d34">dzn</a>=current_state%global_grid%configuration%vertical%dzn(2:)</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160; </div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;    <a class="code" href="namespacepetsc__solver__mod.html#ad3c6adbda077c8f90dbd9aae609409a8">z_start</a>=current_state%local_grid%halo_size(z_index)+2</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;    <a class="code" href="namespacepetsc__solver__mod.html#a46c7d73ab716ad3f636d6f06dc2d16cf">z_end</a>=current_state%local_grid%halo_size(z_index)+current_state%local_grid%size(z_index)</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;    <a class="code" href="namespacepetsc__solver__mod.html#a457ff5121ab099abe67e465d171fe19d">y_start</a>=current_state%local_grid%halo_size(y_index)+1</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;    <a class="code" href="namespacepetsc__solver__mod.html#ae0e6042016d5ce258a542b35adc00e5a">y_end</a>=current_state%local_grid%halo_size(y_index)+current_state%local_grid%size(y_index)</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;    <a class="code" href="namespacepetsc__solver__mod.html#a54b3a29d4b49d4b28f58a359469a948f">x_start</a>=current_state%local_grid%halo_size(x_index)+1</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;    <a class="code" href="namespacepetsc__solver__mod.html#a56796946283179e75de58fe7a375e28a">x_end</a>=current_state%local_grid%halo_size(x_index)+current_state%local_grid%size(x_index)</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160; </div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;    y_rank_val = current_state%parallel%my_rank / current_state%parallel%dim_sizes(x_index)</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;    x_rank_val = mod(current_state%parallel%my_rank, current_state%parallel%dim_sizes(x_index))    </div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;    my_transposed_rank = x_rank_val*current_state%parallel%dim_sizes(y_index) + y_rank_val</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160; </div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;    <span class="keyword">call </span>mpi_comm_split(current_state%parallel%monc_communicator, 1, my_transposed_rank, new_communicator, ierr)</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;    petsc_comm_world = new_communicator</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160; </div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;    <span class="keyword">call </span>petscinitialize(petsc_null_character, ierr)    </div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;    <span class="keyword">call </span>kspcreate(petsc_comm_world, ksp, ierr)</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;    <span class="keyword">call </span>dmdacreate3d(petsc_comm_world, dm_boundary_none, dm_boundary_periodic, dm_boundary_periodic, dmda_stencil_star, &amp;</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;         current_state%global_grid%size(z_index)-1, current_state%global_grid%size(y_index), &amp;</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;         current_state%global_grid%size(x_index), 1, current_state%parallel%dim_sizes(y_index), &amp;</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;         current_state%parallel%dim_sizes(x_index), 1, 1, (/ current_state%global_grid%size(z_index)-1 /), &amp;</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;         y_lengths, x_lengths, da, ierr)</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;    <span class="keyword">call </span>kspsetdm(ksp, da, ierr)</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;    <span class="keyword">call </span>kspsetcomputerhs(ksp, <a class="code" href="namespacepetsc__solver__mod.html#addbf44c53a577676daf2d99eb9c35160">compute_rhs</a>, petsc_null_object, ierr)</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;    <span class="keyword">call </span>kspsetcomputeoperators(ksp, <a class="code" href="namespacepetsc__solver__mod.html#a2b88c61d1e0c123d20dbe75c4bb83bb6">compute_matrix</a>, petsc_null_object, ierr)</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;    <span class="keyword">call </span>kspsetcomputeinitialguess(ksp, <a class="code" href="namespacepetsc__solver__mod.html#a93c8a2ef7386643bd39d313d6aaf3363">compute_initial_guess</a>, petsc_null_object, ierr)</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;    <span class="keyword">call </span>petscoptionssetvalue(<span class="stringliteral">&quot;-options_left&quot;</span>, <span class="stringliteral">&quot;no&quot;</span>, ierr)</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;    <span class="keywordflow">if</span> (trim(options_get_string(current_state%options_database, <span class="stringliteral">&quot;solver_type&quot;</span>)) .ne. <span class="stringliteral">&quot;auto&quot;</span>) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;      <span class="keyword">call </span>petscoptionssetvalue(<span class="stringliteral">&quot;-ksp_type&quot;</span>, trim(options_get_string(current_state%options_database, <span class="stringliteral">&quot;solver_type&quot;</span>)), ierr)</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;<span class="keywordflow">    end if</span></div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;    <span class="keywordflow">if</span> (trim(options_get_string(current_state%options_database, <span class="stringliteral">&quot;preconditioner_type&quot;</span>)) .ne. <span class="stringliteral">&quot;auto&quot;</span>) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;      <span class="keyword">call </span>petscoptionssetvalue(<span class="stringliteral">&quot;-pc_type&quot;</span>, trim(options_get_string(current_state%options_database, <span class="stringliteral">&quot;preconditioner_type&quot;</span>)), ierr)</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;<span class="keywordflow">    end if</span></div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;    <span class="keywordflow">if</span> (trim(options_get_string(current_state%options_database, <span class="stringliteral">&quot;norm_type&quot;</span>)) .ne. <span class="stringliteral">&quot;auto&quot;</span>) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;      <span class="keywordflow">if</span> (trim(options_get_string(current_state%options_database, <span class="stringliteral">&quot;norm_type&quot;</span>)) .eq. <span class="stringliteral">&quot;preconditioned&quot;</span> .or. &amp;</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;           trim(options_get_string(current_state%options_database, <span class="stringliteral">&quot;norm_type&quot;</span>)) .eq. <span class="stringliteral">&quot;unpreconditioned&quot;</span> .or. &amp;</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;           trim(options_get_string(current_state%options_database, <span class="stringliteral">&quot;norm_type&quot;</span>)) .eq. <span class="stringliteral">&quot;natural&quot;</span> .or. &amp;</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;           trim(options_get_string(current_state%options_database, <span class="stringliteral">&quot;norm_type&quot;</span>)) .eq. <span class="stringliteral">&quot;none&quot;</span>) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;        <span class="keyword">call </span>petscoptionssetvalue(<span class="stringliteral">&quot;-ksp_norm_type&quot;</span>, trim(options_get_string(current_state%options_database, <span class="stringliteral">&quot;norm_type&quot;</span>)), ierr)</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;        <span class="keyword">call </span>log_master_log(log_error, <span class="stringliteral">&quot;Configured PETSc norm type of &#39;&quot;</span>//&amp;</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;             trim(options_get_string(current_state%options_database, <span class="stringliteral">&quot;norm_type&quot;</span>))//<span class="stringliteral">&quot;&#39; not recognised&quot;</span>)</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;<span class="keywordflow">      end if</span>      </div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;<span class="keywordflow">    end if</span>    </div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;    <span class="keyword">call </span>petscoptionssetvalue(<span class="stringliteral">&quot;-ksp_rtol&quot;</span>, conv_to_string(options_get_real(current_state%options_database, <span class="stringliteral">&quot;tolerance&quot;</span>)), ierr)</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;    <span class="keywordflow">if</span> (options_get_integer(current_state%options_database, <span class="stringliteral">&quot;max_iterations&quot;</span>) .gt. 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;      <span class="keyword">call </span>petscoptionssetvalue(<span class="stringliteral">&quot;-ksp_max_it&quot;</span>, &amp;</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;           conv_to_string(options_get_integer(current_state%options_database, <span class="stringliteral">&quot;max_iterations&quot;</span>)), ierr)</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;<span class="keywordflow">    end if</span></div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;    <span class="keyword">call </span>kspsetfromoptions(ksp, ierr)</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;    <span class="keyword">call </span>kspsetinitialguessnonzero(ksp, petsc_true, ierr)</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160; </div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;    <span class="keywordflow">if</span> (log_is_master() .and. log_get_logging_level() == log_debug) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;      <span class="keyword">call </span>kspmonitorset(ksp,<a class="code" href="namespacepetsc__solver__mod.html#ac9c7894bec162985659cb8ef37b9cc2b">ksp_monitor</a>,petsc_null_object, petsc_null_function,ierr)</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;<span class="keywordflow">    end if</span>    </div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;    <a class="code" href="namespacepetsc__solver__mod.html#a05bacf56df2bbcbc3ab21d47e759cec7">prev_p</a>=0.0_default_precision</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;    <span class="keyword">call </span>init_halo_communication(current_state, get_single_field_per_halo_cell, <a class="code" href="namespacepetsc__solver__mod.html#ad9fc72a089d8e1881e7bc8f9bd6e542d">halo_swap_state</a>, 1, .false.)</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;    <span class="keyword">call </span>kspgettype(ksp, ksp_type, ierr)</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;    <span class="keyword">call </span>kspgetpc(ksp, pc_instance, ierr)</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;    <span class="keyword">call </span>pcgettype(pc_instance, pc_type, ierr)</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;    <span class="keyword">call </span>log_master_log(log_info, <span class="stringliteral">&quot;PETSc iterative solver initialised, using &quot;</span>//trim(pc_type)//<span class="stringliteral">&quot; preconditioner with &quot;</span>//&amp;</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;         trim(ksp_type)//<span class="stringliteral">&quot; solver&quot;</span>)</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;  <span class="keyword">end subroutine </span><a class="code" href="namespacepetsc__solver__mod.html#adf2548341733155ba725373a96aef324">init_callback</a></div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160; </div>
<div class="line"><a name="l00160"></a><span class="lineno"><a class="line" href="namespacepetsc__solver__mod.html#ac9c7894bec162985659cb8ef37b9cc2b">  160</a></span>&#160;  <span class="keyword">subroutine </span><a class="code" href="namespacepetsc__solver__mod.html#ac9c7894bec162985659cb8ef37b9cc2b">ksp_monitor</a>(ksp, n, rnorm, dummy, ierr)</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;    ksp              ksp</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;    petscerrorcode ierr</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;    petscint n,dummy</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;    petscreal rnorm</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160; </div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;    <span class="keyword">call </span>log_log(log_debug, <span class="stringliteral">&quot;Iteration=&quot;</span>//trim(conv_to_string(n))//<span class="stringliteral">&quot; Rnorm=&quot;</span>//trim(conv_to_string(rnorm, &amp;</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;         exponent_small_numbers=.true.)))</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;  <span class="keyword">end subroutine </span><a class="code" href="namespacepetsc__solver__mod.html#ac9c7894bec162985659cb8ef37b9cc2b">ksp_monitor</a>  </div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160; </div>
<div class="line"><a name="l00174"></a><span class="lineno"><a class="line" href="namespacepetsc__solver__mod.html#a33751edb5b5265c8753e6034a62a15f4">  174</a></span>&#160;  <span class="keyword">subroutine </span><a class="code" href="namespacepetsc__solver__mod.html#a33751edb5b5265c8753e6034a62a15f4">timestep_callback</a>(current_state)</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;    <span class="keywordtype">type</span>(model_state_type), <span class="keywordtype">target</span>, <span class="keywordtype">intent(inout)</span> :: current_state</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;    </div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;    petscerrorcode :: ierr</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;    vec x</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;    petscscalar, <span class="keywordtype">pointer</span> :: xx(:)</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;    <span class="keywordtype">integer</span> :: its, i, j, k</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;    petscreal :: rnorm</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;    kspconvergedreason :: reason</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160; </div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;    <span class="keyword">call </span><a class="code" href="namespacepetsc__solver__mod.html#a1b3240293d99bab7de6b5d6ece1342f1">complete_psrce_calculation</a>(current_state, current_state%local_grid%halo_size(y_index), &amp;</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;         current_state%local_grid%halo_size(x_index))    </div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160; </div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;    <a class="code" href="namespacepetsc__solver__mod.html#a48dcc2baf3f3d5edbab576fc380701b5">p_source</a>=current_state%p%data(<a class="code" href="namespacepetsc__solver__mod.html#ad3c6adbda077c8f90dbd9aae609409a8">z_start</a>:<a class="code" href="namespacepetsc__solver__mod.html#a46c7d73ab716ad3f636d6f06dc2d16cf">z_end</a>, <a class="code" href="namespacepetsc__solver__mod.html#a457ff5121ab099abe67e465d171fe19d">y_start</a>:<a class="code" href="namespacepetsc__solver__mod.html#ae0e6042016d5ce258a542b35adc00e5a">y_end</a>, <a class="code" href="namespacepetsc__solver__mod.html#a54b3a29d4b49d4b28f58a359469a948f">x_start</a>:<a class="code" href="namespacepetsc__solver__mod.html#a56796946283179e75de58fe7a375e28a">x_end</a>)</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;    <span class="keyword">call </span>kspsolve(ksp, petsc_null_object, petsc_null_object, ierr)</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;    <span class="keyword">call </span>kspgetsolution(ksp, x, ierr)</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;    <span class="keyword">call </span>vecgetarrayreadf90(x, xx, ierr)</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;    </div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;    <span class="keyword">call </span><a class="code" href="namespacepetsc__solver__mod.html#af59bc98b1fd5158fc880a6d900f57ff6">copy_petsc_pointer_to_data</a>(xx, <a class="code" href="namespacepetsc__solver__mod.html#ad3c6adbda077c8f90dbd9aae609409a8">z_start</a>, <a class="code" href="namespacepetsc__solver__mod.html#a46c7d73ab716ad3f636d6f06dc2d16cf">z_end</a>, <a class="code" href="namespacepetsc__solver__mod.html#a457ff5121ab099abe67e465d171fe19d">y_start</a>, <a class="code" href="namespacepetsc__solver__mod.html#ae0e6042016d5ce258a542b35adc00e5a">y_end</a>, <a class="code" href="namespacepetsc__solver__mod.html#a54b3a29d4b49d4b28f58a359469a948f">x_start</a>, <a class="code" href="namespacepetsc__solver__mod.html#a56796946283179e75de58fe7a375e28a">x_end</a>, current_state%p%data)</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;    <span class="keyword">call </span>vecrestorearrayreadf90(x, xx, ierr)</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;    </div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;    <a class="code" href="namespacepetsc__solver__mod.html#a05bacf56df2bbcbc3ab21d47e759cec7">prev_p</a>=current_state%p%data(<a class="code" href="namespacepetsc__solver__mod.html#ad3c6adbda077c8f90dbd9aae609409a8">z_start</a>:<a class="code" href="namespacepetsc__solver__mod.html#a46c7d73ab716ad3f636d6f06dc2d16cf">z_end</a>, <a class="code" href="namespacepetsc__solver__mod.html#a457ff5121ab099abe67e465d171fe19d">y_start</a>:<a class="code" href="namespacepetsc__solver__mod.html#ae0e6042016d5ce258a542b35adc00e5a">y_end</a>, <a class="code" href="namespacepetsc__solver__mod.html#a54b3a29d4b49d4b28f58a359469a948f">x_start</a>:<a class="code" href="namespacepetsc__solver__mod.html#a56796946283179e75de58fe7a375e28a">x_end</a>)</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160; </div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;    <span class="keywordflow">if</span> (log_is_master() .and. log_get_logging_level() == log_debug) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;      <span class="keyword">call </span>kspgetiterationnumber(ksp, its, ierr)</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;      <span class="keyword">call </span>kspgetresidualnorm(ksp, rnorm, ierr)</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;      <span class="keyword">call </span>kspgetconvergedreason(ksp, reason, ierr)</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;      <span class="keyword">call </span>log_log(log_debug, <span class="stringliteral">&quot;Converged in &quot;</span>//trim(conv_to_string(its))//<span class="stringliteral">&quot; rnorm=&quot;</span>//trim(conv_to_string(&amp;</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;           rnorm, exponent_small_numbers=.true.))// <span class="stringliteral">&quot; (&quot;</span>//trim(<a class="code" href="namespacepetsc__solver__mod.html#a046b3b5a00b4292d6ee39f569ebf2999">determine_convegence_reason</a>(reason))//<span class="stringliteral">&quot;)&quot;</span>)</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;<span class="keywordflow">    end if</span></div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;    <span class="keyword">call </span>blocking_halo_swap(current_state, <a class="code" href="namespacepetsc__solver__mod.html#ad9fc72a089d8e1881e7bc8f9bd6e542d">halo_swap_state</a>, <a class="code" href="namespacepetsc__solver__mod.html#aab4576f6323bb0b7f34bfd32cfada9db">copy_p_to_halo_buffer</a>, &amp;</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;         <a class="code" href="namespacepetsc__solver__mod.html#a72645c0726f01a37b5a5f4c016b9e51d">perform_local_data_copy_for_p</a>, <a class="code" href="namespacepetsc__solver__mod.html#a3d3a3c93a05d87d97e38d81e09eba9c6">copy_halo_buffer_to_p</a>)</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;  <span class="keyword">end subroutine </span><a class="code" href="namespacepetsc__solver__mod.html#a33751edb5b5265c8753e6034a62a15f4">timestep_callback</a></div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160; </div>
<div class="line"><a name="l00208"></a><span class="lineno"><a class="line" href="namespacepetsc__solver__mod.html#a046b3b5a00b4292d6ee39f569ebf2999">  208</a></span>&#160;  <span class="keyword">character(len=STRING_LENGTH) </span><span class="keyword">function </span><a class="code" href="namespacepetsc__solver__mod.html#a046b3b5a00b4292d6ee39f569ebf2999">determine_convegence_reason</a>(r_code)</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;    <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span> :: r_code</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160; </div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;    <span class="keywordflow">if</span> (r_code == 1 .or. r_code == 2) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;      <a class="code" href="namespacepetsc__solver__mod.html#a046b3b5a00b4292d6ee39f569ebf2999">determine_convegence_reason</a>=<span class="stringliteral">&quot;relative tolerance of residual norm&quot;</span></div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (r_code == 9 .or. r_code == 3) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;      <a class="code" href="namespacepetsc__solver__mod.html#a046b3b5a00b4292d6ee39f569ebf2999">determine_convegence_reason</a>=<span class="stringliteral">&quot;residual norm less than absolute tolerance&quot;</span></div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (r_code == 4) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;      <a class="code" href="namespacepetsc__solver__mod.html#a046b3b5a00b4292d6ee39f569ebf2999">determine_convegence_reason</a>=<span class="stringliteral">&quot;number of iterations exceeded maximum&quot;</span></div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (r_code == -3) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;      <a class="code" href="namespacepetsc__solver__mod.html#a046b3b5a00b4292d6ee39f569ebf2999">determine_convegence_reason</a>=<span class="stringliteral">&quot;diverged as number of iterations exceeded maximum before any convergence criteria&quot;</span></div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (r_code == -4) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;      <a class="code" href="namespacepetsc__solver__mod.html#a046b3b5a00b4292d6ee39f569ebf2999">determine_convegence_reason</a>=<span class="stringliteral">&quot;diverged as divergence tolerance exceeded&quot;</span></div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (r_code .gt. 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;      <a class="code" href="namespacepetsc__solver__mod.html#a046b3b5a00b4292d6ee39f569ebf2999">determine_convegence_reason</a>=<span class="stringliteral">&quot;convergence code of &quot;</span>//conv_to_string(r_code)</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (r_code .lt. 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;      <a class="code" href="namespacepetsc__solver__mod.html#a046b3b5a00b4292d6ee39f569ebf2999">determine_convegence_reason</a>=<span class="stringliteral">&quot;divergence code of &quot;</span>//conv_to_string(r_code)</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;<span class="keywordflow">    end if</span>    </div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;  <span class="keyword">end function </span><a class="code" href="namespacepetsc__solver__mod.html#a046b3b5a00b4292d6ee39f569ebf2999">determine_convegence_reason</a>  </div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160; </div>
<div class="line"><a name="l00234"></a><span class="lineno"><a class="line" href="namespacepetsc__solver__mod.html#a93c8a2ef7386643bd39d313d6aaf3363">  234</a></span>&#160;  <span class="keyword">subroutine </span><a class="code" href="namespacepetsc__solver__mod.html#a93c8a2ef7386643bd39d313d6aaf3363">compute_initial_guess</a>(ksp, x, dummy, ierr)</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;    petscerrorcode :: ierr</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;    ksp :: ksp</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;    vec :: x</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;    <span class="keywordtype">integer</span> :: dummy(*)</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160; </div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;    dm dm</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;    petscscalar, <span class="keywordtype">pointer</span> :: xx(:)</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;    petscint :: zs, ys, xs, zm, ym, xm</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160; </div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;    <span class="keyword">call </span>kspgetdm(ksp, dm, ierr)</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;    <span class="keyword">call </span>dmdagetcorners(dm, zs, ys, xs, zm, ym, xm, ierr)</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;    <span class="keyword">call </span>vecgetarrayf90(x, xx, ierr)</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;    <span class="keyword">call </span><a class="code" href="namespacepetsc__solver__mod.html#a7b88521612a1ff15c57aea2aa6dc5b68">copy_data_to_petsc_pointer</a>(xx, zs, ys, xs, zm, ym, xm, <a class="code" href="namespacepetsc__solver__mod.html#a05bacf56df2bbcbc3ab21d47e759cec7">prev_p</a>)</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;    <span class="keyword">call </span>vecrestorearrayf90(x, xx, ierr)</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;  <span class="keyword">end subroutine </span><a class="code" href="namespacepetsc__solver__mod.html#a93c8a2ef7386643bd39d313d6aaf3363">compute_initial_guess</a>  </div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160; </div>
<div class="line"><a name="l00256"></a><span class="lineno"><a class="line" href="namespacepetsc__solver__mod.html#addbf44c53a577676daf2d99eb9c35160">  256</a></span>&#160;  <span class="keyword">subroutine </span><a class="code" href="namespacepetsc__solver__mod.html#addbf44c53a577676daf2d99eb9c35160">compute_rhs</a>(ksp, b, dummy, ierr)</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;    petscerrorcode :: ierr</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;    ksp :: ksp</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;    vec :: b</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;    <span class="keywordtype">integer</span> :: dummy(*)</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;    </div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;    dm dm</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;    petscscalar, <span class="keywordtype">pointer</span> :: xx(:)</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;    petscint :: zs, ys, xs, zm, ym, xm</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160; </div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;    <span class="keyword">call </span>kspgetdm(ksp, dm, ierr)</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;    <span class="keyword">call </span>dmdagetcorners(dm, zs, ys, xs, zm, ym, xm, ierr)</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;    <span class="keyword">call </span>vecgetarrayf90(b, xx, ierr)</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;    <span class="keyword">call </span><a class="code" href="namespacepetsc__solver__mod.html#a7b88521612a1ff15c57aea2aa6dc5b68">copy_data_to_petsc_pointer</a>(xx, zs, ys, xs, zm, ym, xm, <a class="code" href="namespacepetsc__solver__mod.html#a48dcc2baf3f3d5edbab576fc380701b5">p_source</a>)</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;    <span class="keyword">call </span>vecrestorearrayf90(b, xx, ierr)</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;  <span class="keyword">end subroutine </span><a class="code" href="namespacepetsc__solver__mod.html#addbf44c53a577676daf2d99eb9c35160">compute_rhs</a></div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160; </div>
<div class="line"><a name="l00283"></a><span class="lineno"><a class="line" href="namespacepetsc__solver__mod.html#a7b88521612a1ff15c57aea2aa6dc5b68">  283</a></span>&#160;  <span class="keyword">subroutine </span><a class="code" href="namespacepetsc__solver__mod.html#a7b88521612a1ff15c57aea2aa6dc5b68">copy_data_to_petsc_pointer</a>(x, zs, ys, xs, zm, ym, xm, src_values)</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;    <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span> :: zs, ys, xs, zm, ym, xm</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;    petscscalar, <span class="keywordtype">intent(inout)</span> :: x(zs:zs+zm-1, ys:ys+ym-1, xs:xs+xm-1)</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;<span class="keywordtype">    real</span>(kind=default_precision), <span class="keywordtype">dimension(:,:,:)</span>, <span class="keywordtype">intent(in)</span> :: src_values</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160; </div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;    <span class="keywordtype">integer</span> :: i, j, k</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160; </div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;    <span class="keywordflow">do</span> i=xs, xs+xm-1</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;      <span class="keywordflow">do</span> j=ys, ys+ym-1</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;        <span class="keywordflow">do</span> k=zs, zs+zm-1</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;          x(k, j, i)=src_values((k-zs)+1, (j-ys)+1, (i-xs)+1)</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;<span class="keywordflow">        end do</span></div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;<span class="keywordflow">      end do</span></div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;<span class="keywordflow">    end do</span></div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;  <span class="keyword">end subroutine </span><a class="code" href="namespacepetsc__solver__mod.html#a7b88521612a1ff15c57aea2aa6dc5b68">copy_data_to_petsc_pointer</a></div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160; </div>
<div class="line"><a name="l00309"></a><span class="lineno"><a class="line" href="namespacepetsc__solver__mod.html#af59bc98b1fd5158fc880a6d900f57ff6">  309</a></span>&#160;  <span class="keyword">subroutine </span><a class="code" href="namespacepetsc__solver__mod.html#af59bc98b1fd5158fc880a6d900f57ff6">copy_petsc_pointer_to_data</a>(x, z_start_idx, z_end_idx, y_start_idx, y_end_idx, x_start_idx, x_end_idx, target_values)</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;     <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span> :: z_start_idx, z_end_idx, y_start_idx, y_end_idx, x_start_idx, x_end_idx</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;     petscscalar :: x((z_end_idx-z_start_idx)+1, (y_end_idx-y_start_idx)+1, (x_end_idx-x_start_idx)+1)</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;<span class="keywordtype">     real</span>(kind=default_precision), <span class="keywordtype">dimension(:,:,:)</span>, <span class="keywordtype">intent(inout)</span> :: target_values</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160; </div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;     target_values(z_start_idx:z_end_idx, y_start_idx:y_end_idx, x_start_idx:x_end_idx)=x</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;  <span class="keyword">end subroutine </span><a class="code" href="namespacepetsc__solver__mod.html#af59bc98b1fd5158fc880a6d900f57ff6">copy_petsc_pointer_to_data</a></div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160; </div>
<div class="line"><a name="l00323"></a><span class="lineno"><a class="line" href="namespacepetsc__solver__mod.html#a2b88c61d1e0c123d20dbe75c4bb83bb6">  323</a></span>&#160;  <span class="keyword">subroutine </span><a class="code" href="namespacepetsc__solver__mod.html#a2b88c61d1e0c123d20dbe75c4bb83bb6">compute_matrix</a>(ksp, A, B, dummy, ierr)</div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;    petscerrorcode :: ierr</div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;    ksp :: ksp</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;    mat :: a, b</div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;    <span class="keywordtype">integer</span> :: dummy(*)</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160; </div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;    dm dm</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;    petscint :: zs, ys,xs, zm, ym, xm, mz, my, mx</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;<span class="keywordtype">    real</span>(kind=default_precision) ::  v(7), hx, hy</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;<span class="keywordtype">    real</span>(kind=default_precision), <span class="keywordtype">dimension(:)</span>, <span class="keywordtype">allocatable</span> ::  hzu, hzd, d_sc  </div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;    matstencil :: row(4),col(4,7)</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;    <span class="keywordtype">integer</span> :: i, j, k, num</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160; </div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;    <span class="keyword">call </span>kspgetdm(ksp, dm, ierr)</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;    <span class="keyword">call </span>dmdagetinfo(dm,petsc_null_integer, mz, my, mx, petsc_null_integer, petsc_null_integer, petsc_null_integer, &amp;</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;     petsc_null_integer, petsc_null_integer, petsc_null_integer, petsc_null_integer, petsc_null_integer, petsc_null_integer, ierr)</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;    <span class="keyword">call </span>dmdagetcorners(dm, zs, ys, xs, zm, ym, xm, ierr)</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160; </div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;    <span class="keyword">allocate</span>(hzu(0:mz-1), hzd(0:mz-1), d_sc(0:mz-1))</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160; </div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;    <span class="keywordflow">do</span> k=0, mz-1</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;      d_sc(k)=<a class="code" href="namespacepetsc__solver__mod.html#a9a2540e20466327134ce888b965f3c08">rdz</a>(k+1) / <a class="code" href="namespacepetsc__solver__mod.html#a5c58b8b99675ab89fa495a8cd74f5325">rhon</a>(k+1)</div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;      <span class="keywordflow">if</span> (k .gt. 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;        hzd(k)=<a class="code" href="namespacepetsc__solver__mod.html#a9b84c80ea5d7755ddbab62600239d8dd">rho</a>(k) * <a class="code" href="namespacepetsc__solver__mod.html#a0726b9beb4039fc34bccbaaf0318f0b3">rdzn</a>(k+1)</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;        hzd(k)=0.0_default_precision</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;<span class="keywordflow">      end if</span></div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;      <span class="keywordflow">if</span> (k .lt. mz-1) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;        hzu(k)=<a class="code" href="namespacepetsc__solver__mod.html#a9b84c80ea5d7755ddbab62600239d8dd">rho</a>(k+1) * <a class="code" href="namespacepetsc__solver__mod.html#a0726b9beb4039fc34bccbaaf0318f0b3">rdzn</a>(k+2)</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;        hzu(k)=0.0_default_precision</div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;<span class="keywordflow">      end if</span></div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;<span class="keywordflow">    end do</span>   </div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160; </div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;    hx = <a class="code" href="namespacepetsc__solver__mod.html#a3b8f52c1847557fab15749c1b514971c">cx</a> * <a class="code" href="namespacepetsc__solver__mod.html#a3b8f52c1847557fab15749c1b514971c">cx</a></div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;    hy = <a class="code" href="namespacepetsc__solver__mod.html#af7909ed04090b3bfffd7d5fc33539fcd">cy</a> * <a class="code" href="namespacepetsc__solver__mod.html#af7909ed04090b3bfffd7d5fc33539fcd">cy</a>  </div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;    <span class="keywordflow">do</span> i=xs, xs+xm-1</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;      <span class="keywordflow">do</span> j=ys,ys+ym-1</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;        <span class="keywordflow">do</span> k=zs, zs+zm-1</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;          row(matstencil_i) = k</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;          row(matstencil_j) = j</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;          row(matstencil_k) = i</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160; </div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;          v(1)=hy</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;          col(matstencil_i, 1)=k</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;          col(matstencil_j, 1)=j-1</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;          col(matstencil_k, 1)=i</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;          v(2)=hx</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;          col(matstencil_i, 2)=k</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;          col(matstencil_j, 2)=j</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;          col(matstencil_k, 2)=i-1</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;          v(3)=d_sc(k) * (-(hzu(k) + hzd(k))) - (2.0*(hx + hy))</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;          col(matstencil_i, 3)=k</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;          col(matstencil_j, 3)=j</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;          col(matstencil_k, 3)=i</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;          v(4)=hx</div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;          col(matstencil_i, 4)=k</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;          col(matstencil_j, 4)=j </div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;          col(matstencil_k, 4)=i+1</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;          v(5)=hy</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;          col(matstencil_i, 5)=k</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;          col(matstencil_j, 5)=j+1</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;          col(matstencil_k, 5)=i</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;          num=6</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;          <span class="keywordflow">if</span> (k .gt. zs) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;            v(num)=(d_sc(k)*hzd(k))</div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;            col(matstencil_i, num)=k-1</div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;            col(matstencil_j, num)=j </div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;            col(matstencil_k, num)=i</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;            num=num+1</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;<span class="keywordflow">          end if</span></div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;          <span class="keywordflow">if</span> (k .lt. mz-1) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;            v(num)=(d_sc(k)*hzu(k))</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;            col(matstencil_i, num)=k+1</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;            col(matstencil_j, num)=j</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;            col(matstencil_k, num)=i</div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;            num=num+1</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;<span class="keywordflow">          end if</span></div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;          <span class="keyword">call </span>matsetvaluesstencil(b, 1, row, num-1, col, v, insert_values, ierr)</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;<span class="keywordflow">        end do</span></div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;<span class="keywordflow">      end do</span></div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;<span class="keywordflow">    end do</span></div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;    <span class="keyword">call </span>matassemblybegin(b, mat_final_assembly, ierr)</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;    <span class="keyword">call </span>matassemblyend(b, mat_final_assembly, ierr)</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;    <span class="keywordflow">if</span> ( a .ne. b) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;      <span class="keyword">call </span>matassemblybegin(a, mat_final_assembly, ierr)</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;      <span class="keyword">call </span>matassemblyend(a, mat_final_assembly, ierr)</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;<span class="keywordflow">    endif</span></div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;    <span class="keyword">deallocate</span>(hzu, hzd, d_sc)</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;  <span class="keyword">end subroutine </span><a class="code" href="namespacepetsc__solver__mod.html#a2b88c61d1e0c123d20dbe75c4bb83bb6">compute_matrix</a></div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160; </div>
<div class="line"><a name="l00418"></a><span class="lineno"><a class="line" href="namespacepetsc__solver__mod.html#a7a134894de62b094c42364e7ccfaba02">  418</a></span>&#160;  <span class="keyword">subroutine </span><a class="code" href="namespacepetsc__solver__mod.html#a7a134894de62b094c42364e7ccfaba02">apply_dimension_bounds</a>(dim_size, dim_processes, length_array)</div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;    <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span> :: dim_size, dim_processes</div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;    <span class="keywordtype">integer</span>, <span class="keywordtype">intent(out)</span> :: length_array(:)</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160; </div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;    <span class="keywordtype">integer</span> :: i, dimension_division, dimension_extra</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160; </div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;    dimension_division = dim_size / dim_processes</div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;    length_array= dimension_division    </div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;    </div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;    dimension_extra = dim_size - (dimension_division * dim_processes)</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;    <span class="keywordflow">if</span> (dimension_extra .gt. 0) <span class="keywordflow">then</span></div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;      <span class="keywordflow">do</span> i=1, dimension_extra</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;        length_array(i)=length_array(i)+1</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;<span class="keywordflow">      end do</span></div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;<span class="keywordflow">    end if</span></div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;  <span class="keyword">end subroutine </span><a class="code" href="namespacepetsc__solver__mod.html#a7a134894de62b094c42364e7ccfaba02">apply_dimension_bounds</a></div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160; </div>
<div class="line"><a name="l00440"></a><span class="lineno"><a class="line" href="namespacepetsc__solver__mod.html#a1b3240293d99bab7de6b5d6ece1342f1">  440</a></span>&#160;  <span class="keyword">subroutine </span><a class="code" href="namespacepetsc__solver__mod.html#a1b3240293d99bab7de6b5d6ece1342f1">complete_psrce_calculation</a>(current_state, y_halo_size, x_halo_size)</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;    <span class="keywordtype">type</span>(model_state_type), <span class="keywordtype">target</span>, <span class="keywordtype">intent(inout)</span> :: current_state</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;    <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span> :: y_halo_size, x_halo_size</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160; </div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;    <span class="keywordtype">integer</span> :: ierr, combined_handles(2), i, j, k</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160; </div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;    combined_handles(1)=current_state%psrce_x_hs_recv_request</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;    combined_handles(2)=current_state%psrce_y_hs_recv_request</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;    <span class="keyword">call </span>mpi_waitall(2, combined_handles, mpi_statuses_ignore, ierr)</div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160; </div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;    <span class="keywordflow">do</span> j=current_state%local_grid%local_domain_start_index(y_index), current_state%local_grid%local_domain_end_index(y_index)</div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;      <span class="keywordflow">do</span> k=2,current_state%local_grid%size(z_index)</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;<span class="preprocessor">#ifdef U_ACTIVE</span></div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;<span class="preprocessor"></span>        current_state%p%data(k,j,x_halo_size+1)=current_state%p%data(k,j,x_halo_size+1)-&amp;</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;               current_state%psrce_recv_buffer_x(k-1,j-x_halo_size)</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#ifdef V_ACTIVE</span></div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;<span class="preprocessor"></span>        <span class="keywordflow">if</span> (j .gt. y_halo_size+1) current_state%p%data(k, j, x_halo_size+1)=current_state%p%data(k, j, x_halo_size+1)-&amp;</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;             current_state%global_grid%configuration%horizontal%cy * current_state%sv%data(k, j-1, x_halo_size+1)</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;<span class="preprocessor"></span><span class="keywordflow">      end do</span></div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;<span class="keywordflow">    end do</span></div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;      </div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;<span class="preprocessor">#ifdef V_ACTIVE</span></div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;<span class="preprocessor"></span>    <span class="keywordflow">do</span> i=current_state%local_grid%local_domain_start_index(x_index), current_state%local_grid%local_domain_end_index(x_index)</div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;      <span class="keywordflow">do</span> k=2,current_state%local_grid%size(z_index)</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;        current_state%p%data(k,y_halo_size+1,i)=current_state%p%data(k,y_halo_size+1,i)-&amp;</div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;             current_state%psrce_recv_buffer_y(k-1,i-y_halo_size)</div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;<span class="keywordflow">      end do</span></div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;<span class="keywordflow">    end do</span></div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;<span class="preprocessor"></span> </div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;    combined_handles(1)=current_state%psrce_x_hs_send_request</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;    combined_handles(2)=current_state%psrce_y_hs_send_request</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;    <span class="keyword">call </span>mpi_waitall(2, combined_handles, mpi_statuses_ignore, ierr)</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;  <span class="keyword">end subroutine </span><a class="code" href="namespacepetsc__solver__mod.html#a1b3240293d99bab7de6b5d6ece1342f1">complete_psrce_calculation</a> </div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160; </div>
<div class="line"><a name="l00485"></a><span class="lineno"><a class="line" href="namespacepetsc__solver__mod.html#aab4576f6323bb0b7f34bfd32cfada9db">  485</a></span>&#160;  <span class="keyword">subroutine </span><a class="code" href="namespacepetsc__solver__mod.html#aab4576f6323bb0b7f34bfd32cfada9db">copy_p_to_halo_buffer</a>(current_state, neighbour_description, dim, source_index, &amp;</div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;       pid_location, current_page, source_data)</div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;    <span class="keywordtype">type</span>(model_state_type), <span class="keywordtype">intent(inout)</span> :: current_state</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;    <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span> :: dim, pid_location, source_index</div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;    <span class="keywordtype">integer</span>, <span class="keywordtype">intent(inout)</span> :: current_page(:)</div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;    <span class="keywordtype">type</span>(neighbour_description_type), <span class="keywordtype">intent(inout)</span> :: neighbour_description</div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;    <span class="keywordtype">type</span>(field_data_wrapper_type), <span class="keywordtype">dimension(:)</span>, <span class="keywordtype">intent(in)</span>, <span class="keywordtype">optional</span> :: source_data</div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160; </div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;    <span class="keyword">call </span>copy_field_to_buffer(current_state%local_grid, neighbour_description%send_halo_buffer, current_state%p%data, &amp;</div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;         dim, source_index, current_page(pid_location))</div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160; </div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;    current_page(pid_location)=current_page(pid_location)+1</div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;  <span class="keyword">end subroutine </span><a class="code" href="namespacepetsc__solver__mod.html#aab4576f6323bb0b7f34bfd32cfada9db">copy_p_to_halo_buffer</a></div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160; </div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;  <span class="comment">!! @param dim The dimension we receive for</span></div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;  <span class="comment">!! @param target_index The target index for the dimension we are receiving for</span></div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;  <span class="comment">!! @param neighbour_location The location in the local neighbour data stores of this neighbour</span></div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;  <span class="comment">!! @param current_page The current, next, halo swap page to read from (all previous have been read and copied already)</span></div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;  <span class="comment">!! @param source_data Optional source data which is written into</span></div>
<div class="line"><a name="l00504"></a><span class="lineno"><a class="line" href="namespacepetsc__solver__mod.html#a3d3a3c93a05d87d97e38d81e09eba9c6">  504</a></span>&#160;  <span class="keyword">subroutine </span><a class="code" href="namespacepetsc__solver__mod.html#a3d3a3c93a05d87d97e38d81e09eba9c6">copy_halo_buffer_to_p</a>(current_state, neighbour_description, dim, target_index, &amp;</div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;       neighbour_location, current_page, source_data)</div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;    <span class="keywordtype">type</span>(model_state_type), <span class="keywordtype">intent(inout)</span> :: current_state</div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;    <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span> :: dim, target_index, neighbour_location</div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;    <span class="keywordtype">integer</span>, <span class="keywordtype">intent(inout)</span> :: current_page(:)</div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;    <span class="keywordtype">type</span>(neighbour_description_type), <span class="keywordtype">intent(inout)</span> :: neighbour_description</div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;    <span class="keywordtype">type</span>(field_data_wrapper_type), <span class="keywordtype">dimension(:)</span>, <span class="keywordtype">intent(in)</span>, <span class="keywordtype">optional</span> :: source_data</div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160; </div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;    <span class="keyword">call </span>copy_buffer_to_field(current_state%local_grid, neighbour_description%recv_halo_buffer, current_state%p%data, &amp;</div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;         dim, target_index, current_page(neighbour_location))</div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160; </div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;    current_page(neighbour_location)=current_page(neighbour_location)+1</div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;  <span class="keyword">end subroutine </span><a class="code" href="namespacepetsc__solver__mod.html#a3d3a3c93a05d87d97e38d81e09eba9c6">copy_halo_buffer_to_p</a></div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160; </div>
<div class="line"><a name="l00521"></a><span class="lineno"><a class="line" href="namespacepetsc__solver__mod.html#a72645c0726f01a37b5a5f4c016b9e51d">  521</a></span>&#160;  <span class="keyword">subroutine </span><a class="code" href="namespacepetsc__solver__mod.html#a72645c0726f01a37b5a5f4c016b9e51d">perform_local_data_copy_for_p</a>(current_state, halo_depth, involve_corners, source_data)</div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;    <span class="keywordtype">type</span>(model_state_type), <span class="keywordtype">intent(inout)</span> :: current_state</div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;    <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span> :: halo_depth</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;    <span class="keywordtype">logical</span>, <span class="keywordtype">intent(in)</span> :: involve_corners</div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;    <span class="keywordtype">type</span>(field_data_wrapper_type), <span class="keywordtype">dimension(:)</span>, <span class="keywordtype">intent(in)</span>, <span class="keywordtype">optional</span> :: source_data</div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160; </div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;    <span class="keyword">call </span>perform_local_data_copy_for_field(current_state%p%data, current_state%local_grid, &amp;</div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;         current_state%parallel%my_rank, halo_depth, involve_corners)</div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;  <span class="keyword">end subroutine </span><a class="code" href="namespacepetsc__solver__mod.html#a72645c0726f01a37b5a5f4c016b9e51d">perform_local_data_copy_for_p</a></div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;<span class="keyword">end module </span><a class="code" href="namespacepetsc__solver__mod.html">petsc_solver_mod</a></div>
</div><!-- fragment --></div><!-- contents -->
<div class="ttc" id="anamespacelogging__mod_html_ad68309846cd8f9e77edaa6abd02f65a0"><div class="ttname"><a href="namespacelogging__mod.html#ad68309846cd8f9e77edaa6abd02f65a0">logging_mod::log_error</a></div><div class="ttdeci">integer, parameter, public log_error</div><div class="ttdoc">Only log ERROR messages.</div><div class="ttdef"><b>Definition:</b> <a href="logging_8F90_source.html#l00011">logging.F90:11</a></div></div>
<div class="ttc" id="anamespaceconversions__mod_html"><div class="ttname"><a href="namespaceconversions__mod.html">conversions_mod</a></div><div class="ttdoc">Conversion between common inbuilt FORTRAN data types.</div><div class="ttdef"><b>Definition:</b> <a href="conversions_8F90_source.html#l00005">conversions.F90:5</a></div></div>
<div class="ttc" id="anamespacepetsc__solver__mod_html_a72645c0726f01a37b5a5f4c016b9e51d"><div class="ttname"><a href="namespacepetsc__solver__mod.html#a72645c0726f01a37b5a5f4c016b9e51d">petsc_solver_mod::perform_local_data_copy_for_p</a></div><div class="ttdeci">subroutine perform_local_data_copy_for_p(current_state, halo_depth, involve_corners, source_data)</div><div class="ttdoc">Does local data copying for P variable halo swap.</div><div class="ttdef"><b>Definition:</b> <a href="petsc__solver_8F90_source.html#l00521">petsc_solver.F90:522</a></div></div>
<div class="ttc" id="anamespacepetsc__solver__mod_html_a56796946283179e75de58fe7a375e28a"><div class="ttname"><a href="namespacepetsc__solver__mod.html#a56796946283179e75de58fe7a375e28a">petsc_solver_mod::x_end</a></div><div class="ttdeci">integer x_end</div><div class="ttdef"><b>Definition:</b> <a href="petsc__solver_8F90_source.html#l00030">petsc_solver.F90:30</a></div></div>
<div class="ttc" id="astructcommunication__types__mod_1_1neighbour__description__type_html"><div class="ttname"><a href="structcommunication__types__mod_1_1neighbour__description__type.html">communication_types_mod::neighbour_description_type</a></div><div class="ttdoc">Describes the neighbours of a process in a specific dimension and contains the communication buffers ...</div><div class="ttdef"><b>Definition:</b> <a href="communicationtypes_8F90_source.html#l00020">communicationtypes.F90:20</a></div></div>
<div class="ttc" id="anamespacepetsc__solver__mod_html_a3b8f52c1847557fab15749c1b514971c"><div class="ttname"><a href="namespacepetsc__solver__mod.html#a3b8f52c1847557fab15749c1b514971c">petsc_solver_mod::cx</a></div><div class="ttdeci">real(kind=default_precision) cx</div><div class="ttdef"><b>Definition:</b> <a href="petsc__solver_8F90_source.html#l00034">petsc_solver.F90:34</a></div></div>
<div class="ttc" id="anamespacehalo__communication__mod_html"><div class="ttname"><a href="namespacehalo__communication__mod.html">halo_communication_mod</a></div><div class="ttdoc">Provides the mechanism for halo swapping. This module contains the functionality required to determin...</div><div class="ttdef"><b>Definition:</b> <a href="halocommunication_8F90_source.html#l00008">halocommunication.F90:8</a></div></div>
<div class="ttc" id="anamespacepetsc__solver__mod_html_ac9c7894bec162985659cb8ef37b9cc2b"><div class="ttname"><a href="namespacepetsc__solver__mod.html#ac9c7894bec162985659cb8ef37b9cc2b">petsc_solver_mod::ksp_monitor</a></div><div class="ttdeci">subroutine ksp_monitor(ksp, n, rnorm, dummy, ierr)</div><div class="ttdoc">Monitor procedure called on each iteration, this is provided only at debugging level.</div><div class="ttdef"><b>Definition:</b> <a href="petsc__solver_8F90_source.html#l00160">petsc_solver.F90:161</a></div></div>
<div class="ttc" id="anamespacegrids__mod_html_ab478bbfee0dae6b2e13f3a5eb85be214"><div class="ttname"><a href="namespacegrids__mod.html#ab478bbfee0dae6b2e13f3a5eb85be214">grids_mod::x_index</a></div><div class="ttdeci">integer, parameter, public x_index</div><div class="ttdef"><b>Definition:</b> <a href="grids_8F90_source.html#l00014">grids.F90:14</a></div></div>
<div class="ttc" id="anamespaceoptionsdatabase__mod_html_ae6f0a2a95fcacd3491b7b8fdb161e022"><div class="ttname"><a href="namespaceoptionsdatabase__mod.html#ae6f0a2a95fcacd3491b7b8fdb161e022">optionsdatabase_mod::options_get_integer</a></div><div class="ttdeci">integer function, public options_get_integer(options_database, key, index)</div><div class="ttdoc">Retrieves an integer value from the database that matches the provided key.</div><div class="ttdef"><b>Definition:</b> <a href="optionsdatabase_8F90_source.html#l00216">optionsdatabase.F90:217</a></div></div>
<div class="ttc" id="anamespacegrids__mod_html_aa0e3f2f5767ed33c4b47a761c2af171a"><div class="ttname"><a href="namespacegrids__mod.html#aa0e3f2f5767ed33c4b47a761c2af171a">grids_mod::y_index</a></div><div class="ttdeci">integer, parameter, public y_index</div><div class="ttdef"><b>Definition:</b> <a href="grids_8F90_source.html#l00014">grids.F90:14</a></div></div>
<div class="ttc" id="anamespacepetsc__solver__mod_html_ab16254aead68a763822c781f41feccf6"><div class="ttname"><a href="namespacepetsc__solver__mod.html#ab16254aead68a763822c781f41feccf6">petsc_solver_mod::finalisation_callback</a></div><div class="ttdeci">subroutine finalisation_callback(current_state)</div><div class="ttdef"><b>Definition:</b> <a href="petsc__solver_8F90_source.html#l00051">petsc_solver.F90:52</a></div></div>
<div class="ttc" id="anamespacepetsc__solver__mod_html_a48dcc2baf3f3d5edbab576fc380701b5"><div class="ttname"><a href="namespacepetsc__solver__mod.html#a48dcc2baf3f3d5edbab576fc380701b5">petsc_solver_mod::p_source</a></div><div class="ttdeci">real(kind=default_precision), dimension(:,:,:), allocatable p_source</div><div class="ttdef"><b>Definition:</b> <a href="petsc__solver_8F90_source.html#l00033">petsc_solver.F90:33</a></div></div>
<div class="ttc" id="anamespacepetsc__solver__mod_html_abb609729a980841b02373e46e40de705"><div class="ttname"><a href="namespacepetsc__solver__mod.html#abb609729a980841b02373e46e40de705">petsc_solver_mod::dz</a></div><div class="ttdeci">real(kind=default_precision), dimension(:), allocatable dz</div><div class="ttdef"><b>Definition:</b> <a href="petsc__solver_8F90_source.html#l00035">petsc_solver.F90:35</a></div></div>
<div class="ttc" id="anamespacepetsc__solver__mod_html_aab4576f6323bb0b7f34bfd32cfada9db"><div class="ttname"><a href="namespacepetsc__solver__mod.html#aab4576f6323bb0b7f34bfd32cfada9db">petsc_solver_mod::copy_p_to_halo_buffer</a></div><div class="ttdeci">subroutine copy_p_to_halo_buffer(current_state, neighbour_description, dim, source_index, pid_location, current_page, source_data)</div><div class="ttdoc">Copies the p field data to halo buffers for a specific process in a dimension and halo cell.</div><div class="ttdef"><b>Definition:</b> <a href="petsc__solver_8F90_source.html#l00485">petsc_solver.F90:487</a></div></div>
<div class="ttc" id="anamespacepetsc__solver__mod_html_a3d3a3c93a05d87d97e38d81e09eba9c6"><div class="ttname"><a href="namespacepetsc__solver__mod.html#a3d3a3c93a05d87d97e38d81e09eba9c6">petsc_solver_mod::copy_halo_buffer_to_p</a></div><div class="ttdeci">subroutine copy_halo_buffer_to_p(current_state, neighbour_description, dim, target_index, neighbour_location, current_page, source_data)</div><div class="ttdef"><b>Definition:</b> <a href="petsc__solver_8F90_source.html#l00504">petsc_solver.F90:506</a></div></div>
<div class="ttc" id="anamespacehalo__communication__mod_html_ac287e4b520fd9a75f35e58e67ec52880"><div class="ttname"><a href="namespacehalo__communication__mod.html#ac287e4b520fd9a75f35e58e67ec52880">halo_communication_mod::init_halo_communication</a></div><div class="ttdeci">subroutine, public init_halo_communication(current_state, get_fields_per_halo_cell, halo_state, halo_depth, involve_corners)</div><div class="ttdoc">Initialises a halo swapping state, by determining the neighbours, size of data in each swap and alloc...</div><div class="ttdef"><b>Definition:</b> <a href="halocommunication_8F90_source.html#l00293">halocommunication.F90:295</a></div></div>
<div class="ttc" id="anamespacelogging__mod_html_ac7d5c1fcb00d54277580c10556aa78a8"><div class="ttname"><a href="namespacelogging__mod.html#ac7d5c1fcb00d54277580c10556aa78a8">logging_mod::log_info</a></div><div class="ttdeci">integer, parameter, public log_info</div><div class="ttdoc">Log INFO, WARNING and ERROR messages.</div><div class="ttdef"><b>Definition:</b> <a href="logging_8F90_source.html#l00013">logging.F90:13</a></div></div>
<div class="ttc" id="anamespacecommunication__types__mod_html"><div class="ttname"><a href="namespacecommunication__types__mod.html">communication_types_mod</a></div><div class="ttdoc">Contains the types used for communication, holding the state of communications and supporting activit...</div><div class="ttdef"><b>Definition:</b> <a href="communicationtypes_8F90_source.html#l00005">communicationtypes.F90:5</a></div></div>
<div class="ttc" id="anamespacepetsc__solver__mod_html_a54b3a29d4b49d4b28f58a359469a948f"><div class="ttname"><a href="namespacepetsc__solver__mod.html#a54b3a29d4b49d4b28f58a359469a948f">petsc_solver_mod::x_start</a></div><div class="ttdeci">integer x_start</div><div class="ttdef"><b>Definition:</b> <a href="petsc__solver_8F90_source.html#l00030">petsc_solver.F90:30</a></div></div>
<div class="ttc" id="anamespacelogging__mod_html_ac4f13ac385499c85190cb184030e4f45"><div class="ttname"><a href="namespacelogging__mod.html#ac4f13ac385499c85190cb184030e4f45">logging_mod::log_log</a></div><div class="ttdeci">subroutine, public log_log(level, message, str)</div><div class="ttdoc">Logs a message at the specified level. If the level is above the current level then the message is ig...</div><div class="ttdef"><b>Definition:</b> <a href="logging_8F90_source.html#l00074">logging.F90:75</a></div></div>
<div class="ttc" id="anamespacepetsc__solver__mod_html_a93c8a2ef7386643bd39d313d6aaf3363"><div class="ttname"><a href="namespacepetsc__solver__mod.html#a93c8a2ef7386643bd39d313d6aaf3363">petsc_solver_mod::compute_initial_guess</a></div><div class="ttdeci">subroutine compute_initial_guess(ksp, x, dummy, ierr)</div><div class="ttdoc">Determines the initial guess, this is called from within PETSc and sets it to be the last value of P ...</div><div class="ttdef"><b>Definition:</b> <a href="petsc__solver_8F90_source.html#l00234">petsc_solver.F90:235</a></div></div>
<div class="ttc" id="anamespacelogging__mod_html_ae0d255e756059bc76b2f4291825e59c9"><div class="ttname"><a href="namespacelogging__mod.html#ae0d255e756059bc76b2f4291825e59c9">logging_mod::log_get_logging_level</a></div><div class="ttdeci">integer function, public log_get_logging_level()</div><div class="ttdoc">Retrieves the current logging level.</div><div class="ttdef"><b>Definition:</b> <a href="logging_8F90_source.html#l00121">logging.F90:122</a></div></div>
<div class="ttc" id="anamespacepetsc__solver__mod_html_ad9fc72a089d8e1881e7bc8f9bd6e542d"><div class="ttname"><a href="namespacepetsc__solver__mod.html#ad9fc72a089d8e1881e7bc8f9bd6e542d">petsc_solver_mod::halo_swap_state</a></div><div class="ttdeci">type(halo_communication_type), save halo_swap_state</div><div class="ttdef"><b>Definition:</b> <a href="petsc__solver_8F90_source.html#l00031">petsc_solver.F90:31</a></div></div>
<div class="ttc" id="anamespacepetsc__solver__mod_html_a9b84c80ea5d7755ddbab62600239d8dd"><div class="ttname"><a href="namespacepetsc__solver__mod.html#a9b84c80ea5d7755ddbab62600239d8dd">petsc_solver_mod::rho</a></div><div class="ttdeci">real(kind=default_precision), dimension(:), allocatable rho</div><div class="ttdef"><b>Definition:</b> <a href="petsc__solver_8F90_source.html#l00035">petsc_solver.F90:35</a></div></div>
<div class="ttc" id="anamespacehalo__communication__mod_html_a213c2f386f6a61af7053b74d9c3babbb"><div class="ttname"><a href="namespacehalo__communication__mod.html#a213c2f386f6a61af7053b74d9c3babbb">halo_communication_mod::copy_field_to_buffer</a></div><div class="ttdeci">subroutine, public copy_field_to_buffer(local_grid, halo_buffer, field_data, dim, source_index, halo_page)</div><div class="ttdoc">Copies prognostic field data to send buffer for specific field, dimension, halo cell.</div><div class="ttdef"><b>Definition:</b> <a href="halocommunication_8F90_source.html#l00431">halocommunication.F90:433</a></div></div>
<div class="ttc" id="anamespacelogging__mod_html_aca1c925af27b4d533d548bfe69a819f3"><div class="ttname"><a href="namespacelogging__mod.html#aca1c925af27b4d533d548bfe69a819f3">logging_mod::log_debug</a></div><div class="ttdeci">integer, parameter, public log_debug</div><div class="ttdoc">Log DEBUG, INFO, WARNING and ERROR messages.</div><div class="ttdef"><b>Definition:</b> <a href="logging_8F90_source.html#l00014">logging.F90:14</a></div></div>
<div class="ttc" id="astructcommunication__types__mod_1_1halo__communication__type_html"><div class="ttname"><a href="structcommunication__types__mod_1_1halo__communication__type.html">communication_types_mod::halo_communication_type</a></div><div class="ttdoc">Maintains the state of a halo swap and contains buffers, neighbours etc.</div><div class="ttdef"><b>Definition:</b> <a href="communicationtypes_8F90_source.html#l00028">communicationtypes.F90:28</a></div></div>
<div class="ttc" id="anamespacepetsc__solver__mod_html_a33751edb5b5265c8753e6034a62a15f4"><div class="ttname"><a href="namespacepetsc__solver__mod.html#a33751edb5b5265c8753e6034a62a15f4">petsc_solver_mod::timestep_callback</a></div><div class="ttdeci">subroutine timestep_callback(current_state)</div><div class="ttdoc">Timestep hook which is called at each timestep to solve the pressure equation via PETSc....</div><div class="ttdef"><b>Definition:</b> <a href="petsc__solver_8F90_source.html#l00174">petsc_solver.F90:175</a></div></div>
<div class="ttc" id="anamespacemonc__component__mod_html"><div class="ttname"><a href="namespacemonc__component__mod.html">monc_component_mod</a></div><div class="ttdoc">Interfaces and types that MONC components must specify.</div><div class="ttdef"><b>Definition:</b> <a href="monc__component_8F90_source.html#l00006">monc_component.F90:6</a></div></div>
<div class="ttc" id="astructcommunication__types__mod_1_1field__data__wrapper__type_html"><div class="ttname"><a href="structcommunication__types__mod_1_1field__data__wrapper__type.html">communication_types_mod::field_data_wrapper_type</a></div><div class="ttdef"><b>Definition:</b> <a href="communicationtypes_8F90_source.html#l00014">communicationtypes.F90:14</a></div></div>
<div class="ttc" id="anamespacepetsc__solver__mod_html_af59bc98b1fd5158fc880a6d900f57ff6"><div class="ttname"><a href="namespacepetsc__solver__mod.html#af59bc98b1fd5158fc880a6d900f57ff6">petsc_solver_mod::copy_petsc_pointer_to_data</a></div><div class="ttdeci">subroutine copy_petsc_pointer_to_data(x, z_start_idx, z_end_idx, y_start_idx, y_end_idx, x_start_idx, x_end_idx, target_values)</div><div class="ttdoc">Copies the data in a pointer that was provided by PETSc into some target data, doing it this way mean...</div><div class="ttdef"><b>Definition:</b> <a href="petsc__solver_8F90_source.html#l00309">petsc_solver.F90:310</a></div></div>
<div class="ttc" id="anamespacepetsc__solver__mod_html_af7909ed04090b3bfffd7d5fc33539fcd"><div class="ttname"><a href="namespacepetsc__solver__mod.html#af7909ed04090b3bfffd7d5fc33539fcd">petsc_solver_mod::cy</a></div><div class="ttdeci">real(kind=default_precision) cy</div><div class="ttdef"><b>Definition:</b> <a href="petsc__solver_8F90_source.html#l00034">petsc_solver.F90:34</a></div></div>
<div class="ttc" id="anamespaceoptionsdatabase__mod_html_af2aeb42c9fdb961702216042b0330088"><div class="ttname"><a href="namespaceoptionsdatabase__mod.html#af2aeb42c9fdb961702216042b0330088">optionsdatabase_mod::options_get_string</a></div><div class="ttdeci">character(len=string_length) function, public options_get_string(options_database, key, index)</div><div class="ttdoc">Retrieves a string value from the database that matches the provided key.</div><div class="ttdef"><b>Definition:</b> <a href="optionsdatabase_8F90_source.html#l00279">optionsdatabase.F90:280</a></div></div>
<div class="ttc" id="anamespacepetsc__solver__mod_html_a46c7d73ab716ad3f636d6f06dc2d16cf"><div class="ttname"><a href="namespacepetsc__solver__mod.html#a46c7d73ab716ad3f636d6f06dc2d16cf">petsc_solver_mod::z_end</a></div><div class="ttdeci">integer z_end</div><div class="ttdef"><b>Definition:</b> <a href="petsc__solver_8F90_source.html#l00030">petsc_solver.F90:30</a></div></div>
<div class="ttc" id="anamespacepetsc__solver__mod_html_adf2548341733155ba725373a96aef324"><div class="ttname"><a href="namespacepetsc__solver__mod.html#adf2548341733155ba725373a96aef324">petsc_solver_mod::init_callback</a></div><div class="ttdeci">subroutine init_callback(current_state)</div><div class="ttdoc">Called upon model initialisation. Will basically read from the options database and set options in th...</div><div class="ttdef"><b>Definition:</b> <a href="petsc__solver_8F90_source.html#l00062">petsc_solver.F90:63</a></div></div>
<div class="ttc" id="anamespacepetsc__solver__mod_html_a9a2540e20466327134ce888b965f3c08"><div class="ttname"><a href="namespacepetsc__solver__mod.html#a9a2540e20466327134ce888b965f3c08">petsc_solver_mod::rdz</a></div><div class="ttdeci">real(kind=default_precision), dimension(:), allocatable rdz</div><div class="ttdef"><b>Definition:</b> <a href="petsc__solver_8F90_source.html#l00035">petsc_solver.F90:35</a></div></div>
<div class="ttc" id="anamespacepetsc__solver__mod_html_a7a134894de62b094c42364e7ccfaba02"><div class="ttname"><a href="namespacepetsc__solver__mod.html#a7a134894de62b094c42364e7ccfaba02">petsc_solver_mod::apply_dimension_bounds</a></div><div class="ttdeci">subroutine apply_dimension_bounds(dim_size, dim_processes, length_array)</div><div class="ttdoc">Applies dimension bounds to determine the number of elements held locally for each process in that di...</div><div class="ttdef"><b>Definition:</b> <a href="petsc__solver_8F90_source.html#l00418">petsc_solver.F90:419</a></div></div>
<div class="ttc" id="anamespacepetsc__solver__mod_html_a457ff5121ab099abe67e465d171fe19d"><div class="ttname"><a href="namespacepetsc__solver__mod.html#a457ff5121ab099abe67e465d171fe19d">petsc_solver_mod::y_start</a></div><div class="ttdeci">integer y_start</div><div class="ttdef"><b>Definition:</b> <a href="petsc__solver_8F90_source.html#l00030">petsc_solver.F90:30</a></div></div>
<div class="ttc" id="anamespacepetsc__solver__mod_html_a1b3240293d99bab7de6b5d6ece1342f1"><div class="ttname"><a href="namespacepetsc__solver__mod.html#a1b3240293d99bab7de6b5d6ece1342f1">petsc_solver_mod::complete_psrce_calculation</a></div><div class="ttdeci">subroutine complete_psrce_calculation(current_state, y_halo_size, x_halo_size)</div><div class="ttdoc">Completes the psrce calculation by waiting on all outstanding psrce communications to complete and th...</div><div class="ttdef"><b>Definition:</b> <a href="petsc__solver_8F90_source.html#l00440">petsc_solver.F90:441</a></div></div>
<div class="ttc" id="anamespacegrids__mod_html_aa1eee0ed41ef0446ae1a6155b78a2239"><div class="ttname"><a href="namespacegrids__mod.html#aa1eee0ed41ef0446ae1a6155b78a2239">grids_mod::z_index</a></div><div class="ttdeci">integer, parameter, public z_index</div><div class="ttdoc">Grid index parameters.</div><div class="ttdef"><b>Definition:</b> <a href="grids_8F90_source.html#l00014">grids.F90:14</a></div></div>
<div class="ttc" id="anamespacepetsc__solver__mod_html_ae0e6042016d5ce258a542b35adc00e5a"><div class="ttname"><a href="namespacepetsc__solver__mod.html#ae0e6042016d5ce258a542b35adc00e5a">petsc_solver_mod::y_end</a></div><div class="ttdeci">integer y_end</div><div class="ttdef"><b>Definition:</b> <a href="petsc__solver_8F90_source.html#l00030">petsc_solver.F90:30</a></div></div>
<div class="ttc" id="ainterfaceconversions__mod_1_1conv__to__string_html"><div class="ttname"><a href="interfaceconversions__mod_1_1conv__to__string.html">conversions_mod::conv_to_string</a></div><div class="ttdoc">Converts data types to strings.</div><div class="ttdef"><b>Definition:</b> <a href="conversions_8F90_source.html#l00038">conversions.F90:38</a></div></div>
<div class="ttc" id="anamespacepetsc__solver__mod_html_a7b88521612a1ff15c57aea2aa6dc5b68"><div class="ttname"><a href="namespacepetsc__solver__mod.html#a7b88521612a1ff15c57aea2aa6dc5b68">petsc_solver_mod::copy_data_to_petsc_pointer</a></div><div class="ttdeci">subroutine copy_data_to_petsc_pointer(x, zs, ys, xs, zm, ym, xm, src_values)</div><div class="ttdoc">Copies data into a data pointer which is provided by PETSc, doing it this ways allows us to give a sh...</div><div class="ttdef"><b>Definition:</b> <a href="petsc__solver_8F90_source.html#l00283">petsc_solver.F90:284</a></div></div>
<div class="ttc" id="astructstate__mod_1_1model__state__type_html"><div class="ttname"><a href="structstate__mod_1_1model__state__type.html">state_mod::model_state_type</a></div><div class="ttdoc">The ModelState which represents the current state of a run.</div><div class="ttdef"><b>Definition:</b> <a href="state_8F90_source.html#l00039">state.F90:39</a></div></div>
<div class="ttc" id="anamespacepetsc__solver__mod_html_a05bacf56df2bbcbc3ab21d47e759cec7"><div class="ttname"><a href="namespacepetsc__solver__mod.html#a05bacf56df2bbcbc3ab21d47e759cec7">petsc_solver_mod::prev_p</a></div><div class="ttdeci">real(kind=default_precision), dimension(:,:,:), allocatable prev_p</div><div class="ttdef"><b>Definition:</b> <a href="petsc__solver_8F90_source.html#l00033">petsc_solver.F90:33</a></div></div>
<div class="ttc" id="anamespacehalo__communication__mod_html_af69a6efcccb7091a6735135bb468c765"><div class="ttname"><a href="namespacehalo__communication__mod.html#af69a6efcccb7091a6735135bb468c765">halo_communication_mod::copy_buffer_to_field</a></div><div class="ttdeci">subroutine, public copy_buffer_to_field(local_grid, halo_buffer, field_data, dim, target_index, halo_page)</div><div class="ttdoc">Copies the received buffer for a specific field to the corresponding halo data of that prognostic fie...</div><div class="ttdef"><b>Definition:</b> <a href="halocommunication_8F90_source.html#l00399">halocommunication.F90:401</a></div></div>
<div class="ttc" id="astructgrids__mod_1_1local__grid__type_html"><div class="ttname"><a href="structgrids__mod_1_1local__grid__type.html">grids_mod::local_grid_type</a></div><div class="ttdoc">Defined the local grid, i.e. the grid held on this process after decomposition.</div><div class="ttdef"><b>Definition:</b> <a href="grids_8F90_source.html#l00118">grids.F90:118</a></div></div>
<div class="ttc" id="anamespacepetsc__solver__mod_html_a0726b9beb4039fc34bccbaaf0318f0b3"><div class="ttname"><a href="namespacepetsc__solver__mod.html#a0726b9beb4039fc34bccbaaf0318f0b3">petsc_solver_mod::rdzn</a></div><div class="ttdeci">real(kind=default_precision), dimension(:), allocatable rdzn</div><div class="ttdef"><b>Definition:</b> <a href="petsc__solver_8F90_source.html#l00035">petsc_solver.F90:35</a></div></div>
<div class="ttc" id="anamespacelogging__mod_html_aa7d08e4de819bf03922844a8366c28ae"><div class="ttname"><a href="namespacelogging__mod.html#aa7d08e4de819bf03922844a8366c28ae">logging_mod::log_is_master</a></div><div class="ttdeci">logical function, public log_is_master()</div><div class="ttdoc">Determines whether the process is the master logging process. This might be preferable rather than ca...</div><div class="ttdef"><b>Definition:</b> <a href="logging_8F90_source.html#l00065">logging.F90:66</a></div></div>
<div class="ttc" id="anamespacelogging__mod_html"><div class="ttname"><a href="namespacelogging__mod.html">logging_mod</a></div><div class="ttdoc">Logging utility.</div><div class="ttdef"><b>Definition:</b> <a href="logging_8F90_source.html#l00002">logging.F90:2</a></div></div>
<div class="ttc" id="anamespacedatadefn__mod_html"><div class="ttname"><a href="namespacedatadefn__mod.html">datadefn_mod</a></div><div class="ttdoc">Contains common definitions for the data and datatypes used by MONC.</div><div class="ttdef"><b>Definition:</b> <a href="datadefn_8F90_source.html#l00002">datadefn.F90:2</a></div></div>
<div class="ttc" id="anamespacedatadefn__mod_html_a9e9ab0279f2158e1e0e259259f014bd1"><div class="ttname"><a href="namespacedatadefn__mod.html#a9e9ab0279f2158e1e0e259259f014bd1">datadefn_mod::string_length</a></div><div class="ttdeci">integer, parameter, public string_length</div><div class="ttdoc">Default length of strings.</div><div class="ttdef"><b>Definition:</b> <a href="datadefn_8F90_source.html#l00010">datadefn.F90:10</a></div></div>
<div class="ttc" id="anamespacelogging__mod_html_ad95937a250467334622daeb5cff78c20"><div class="ttname"><a href="namespacelogging__mod.html#ad95937a250467334622daeb5cff78c20">logging_mod::log_master_log</a></div><div class="ttdeci">subroutine, public log_master_log(level, message)</div><div class="ttdoc">Will log just from the master process.</div><div class="ttdef"><b>Definition:</b> <a href="logging_8F90_source.html#l00046">logging.F90:47</a></div></div>
<div class="ttc" id="anamespacepetsc__solver__mod_html_addbf44c53a577676daf2d99eb9c35160"><div class="ttname"><a href="namespacepetsc__solver__mod.html#addbf44c53a577676daf2d99eb9c35160">petsc_solver_mod::compute_rhs</a></div><div class="ttdeci">subroutine compute_rhs(ksp, b, dummy, ierr)</div><div class="ttdoc">Callback issued from the PETSc library to compute the RHS, this is called every timestep (as we have ...</div><div class="ttdef"><b>Definition:</b> <a href="petsc__solver_8F90_source.html#l00256">petsc_solver.F90:257</a></div></div>
<div class="ttc" id="anamespacepetsc__solver__mod_html_a2b88c61d1e0c123d20dbe75c4bb83bb6"><div class="ttname"><a href="namespacepetsc__solver__mod.html#a2b88c61d1e0c123d20dbe75c4bb83bb6">petsc_solver_mod::compute_matrix</a></div><div class="ttdeci">subroutine compute_matrix(ksp, A, B, dummy, ierr)</div><div class="ttdoc">Call back issued from within PETSc to create the matrix, this is only called once (the first PETSc ru...</div><div class="ttdef"><b>Definition:</b> <a href="petsc__solver_8F90_source.html#l00323">petsc_solver.F90:324</a></div></div>
<div class="ttc" id="anamespacepetsc__solver__mod_html_a529b7788cbcf56a4b00add8b23179d34"><div class="ttname"><a href="namespacepetsc__solver__mod.html#a529b7788cbcf56a4b00add8b23179d34">petsc_solver_mod::dzn</a></div><div class="ttdeci">real(kind=default_precision), dimension(:), allocatable dzn</div><div class="ttdef"><b>Definition:</b> <a href="petsc__solver_8F90_source.html#l00035">petsc_solver.F90:35</a></div></div>
<div class="ttc" id="anamespacepetsc__solver__mod_html_ad3c6adbda077c8f90dbd9aae609409a8"><div class="ttname"><a href="namespacepetsc__solver__mod.html#ad3c6adbda077c8f90dbd9aae609409a8">petsc_solver_mod::z_start</a></div><div class="ttdeci">integer z_start</div><div class="ttdef"><b>Definition:</b> <a href="petsc__solver_8F90_source.html#l00030">petsc_solver.F90:30</a></div></div>
<div class="ttc" id="anamespacepetsc__solver__mod_html"><div class="ttname"><a href="namespacepetsc__solver__mod.html">petsc_solver_mod</a></div><div class="ttdoc">PETSc solver component to call out to PETSc for solving the Poisson equation for pressure.</div><div class="ttdef"><b>Definition:</b> <a href="petsc__solver_8F90_source.html#l00006">petsc_solver.F90:6</a></div></div>
<div class="ttc" id="anamespacepetsc__solver__mod_html_a046b3b5a00b4292d6ee39f569ebf2999"><div class="ttname"><a href="namespacepetsc__solver__mod.html#a046b3b5a00b4292d6ee39f569ebf2999">petsc_solver_mod::determine_convegence_reason</a></div><div class="ttdeci">character(len=string_length) function determine_convegence_reason(r_code)</div><div class="ttdef"><b>Definition:</b> <a href="petsc__solver_8F90_source.html#l00208">petsc_solver.F90:209</a></div></div>
<div class="ttc" id="anamespacehalo__communication__mod_html_aaff14692e79ef19796f8c6af98bc6ef9"><div class="ttname"><a href="namespacehalo__communication__mod.html#aaff14692e79ef19796f8c6af98bc6ef9">halo_communication_mod::get_single_field_per_halo_cell</a></div><div class="ttdeci">integer function, public get_single_field_per_halo_cell(current_state)</div><div class="ttdoc">A very common function, which returns a single field per halo cell which is used to halo swap just on...</div><div class="ttdef"><b>Definition:</b> <a href="halocommunication_8F90_source.html#l01229">halocommunication.F90:1230</a></div></div>
<div class="ttc" id="anamespacehalo__communication__mod_html_a0a11eeeaa1e80eab180fb8652ce592a6"><div class="ttname"><a href="namespacehalo__communication__mod.html#a0a11eeeaa1e80eab180fb8652ce592a6">halo_communication_mod::blocking_halo_swap</a></div><div class="ttdeci">subroutine, public blocking_halo_swap(current_state, halo_swap_state, copy_to_halo_buffer, perform_local_data_copy, copy_from_halo_buffer, copy_corners_to_halo_buffer, copy_from_halo_buffer_to_corner, source_data)</div><div class="ttdoc">Performs the entire halo swap operation, this is simply a wrapper around the nonblocking initiate and...</div><div class="ttdef"><b>Definition:</b> <a href="halocommunication_8F90_source.html#l00109">halocommunication.F90:112</a></div></div>
<div class="ttc" id="anamespacepetsc__solver__mod_html_a5c58b8b99675ab89fa495a8cd74f5325"><div class="ttname"><a href="namespacepetsc__solver__mod.html#a5c58b8b99675ab89fa495a8cd74f5325">petsc_solver_mod::rhon</a></div><div class="ttdeci">real(kind=default_precision), dimension(:), allocatable rhon</div><div class="ttdef"><b>Definition:</b> <a href="petsc__solver_8F90_source.html#l00035">petsc_solver.F90:35</a></div></div>
<div class="ttc" id="anamespacegrids__mod_html"><div class="ttname"><a href="namespacegrids__mod.html">grids_mod</a></div><div class="ttdoc">Functionality to support the different types of grid and abstraction between global grids and local o...</div><div class="ttdef"><b>Definition:</b> <a href="grids_8F90_source.html#l00005">grids.F90:5</a></div></div>
<div class="ttc" id="anamespacehalo__communication__mod_html_a9f9daddadb8276b6a0d2d13e2e8ce1d5"><div class="ttname"><a href="namespacehalo__communication__mod.html#a9f9daddadb8276b6a0d2d13e2e8ce1d5">halo_communication_mod::finalise_halo_communication</a></div><div class="ttdeci">subroutine, public finalise_halo_communication(halo_swap_state)</div><div class="ttdoc">Finalises the halo swap represented by the state by freeing up all the allocated memory.</div><div class="ttdef"><b>Definition:</b> <a href="halocommunication_8F90_source.html#l00339">halocommunication.F90:340</a></div></div>
<div class="ttc" id="anamespaceoptionsdatabase__mod_html"><div class="ttname"><a href="namespaceoptionsdatabase__mod.html">optionsdatabase_mod</a></div><div class="ttdoc">Manages the options database. Contains administration functions and deduce runtime options from the c...</div><div class="ttdef"><b>Definition:</b> <a href="optionsdatabase_8F90_source.html#l00007">optionsdatabase.F90:7</a></div></div>
<div class="ttc" id="astructmonc__component__mod_1_1component__descriptor__type_html"><div class="ttname"><a href="structmonc__component__mod_1_1component__descriptor__type.html">monc_component_mod::component_descriptor_type</a></div><div class="ttdoc">Description of a component.</div><div class="ttdef"><b>Definition:</b> <a href="monc__component_8F90_source.html#l00042">monc_component.F90:42</a></div></div>
<div class="ttc" id="anamespaceoptionsdatabase__mod_html_ab054641ac0fa0287adb3c461987c4f0b"><div class="ttname"><a href="namespaceoptionsdatabase__mod.html#ab054641ac0fa0287adb3c461987c4f0b">optionsdatabase_mod::options_get_real</a></div><div class="ttdeci">real(kind=default_precision) function, public options_get_real(options_database, key, index)</div><div class="ttdoc">Retrieves a real value from the database that matches the provided key.</div><div class="ttdef"><b>Definition:</b> <a href="optionsdatabase_8F90_source.html#l00090">optionsdatabase.F90:91</a></div></div>
<div class="ttc" id="anamespacehalo__communication__mod_html_a2eba69a892b0533614ecccad674e61ed"><div class="ttname"><a href="namespacehalo__communication__mod.html#a2eba69a892b0533614ecccad674e61ed">halo_communication_mod::perform_local_data_copy_for_field</a></div><div class="ttdeci">subroutine, public perform_local_data_copy_for_field(field_data, local_grid, my_rank, halo_depth, involve_corners)</div><div class="ttdoc">Will perform a a local copy for the halo data of a field.</div><div class="ttdef"><b>Definition:</b> <a href="halocommunication_8F90_source.html#l00481">halocommunication.F90:483</a></div></div>
<div class="ttc" id="anamespacedatadefn__mod_html_a39b79f8cc843d236d3b47f5c81b64368"><div class="ttname"><a href="namespacedatadefn__mod.html#a39b79f8cc843d236d3b47f5c81b64368">datadefn_mod::default_precision</a></div><div class="ttdeci">integer, parameter, public default_precision</div><div class="ttdoc">MPI communication type which we use for the prognostic and calculation data.</div><div class="ttdef"><b>Definition:</b> <a href="datadefn_8F90_source.html#l00017">datadefn.F90:17</a></div></div>
<div class="ttc" id="anamespacestate__mod_html"><div class="ttname"><a href="namespacestate__mod.html">state_mod</a></div><div class="ttdoc">The model state which represents the current state of a run.</div><div class="ttdef"><b>Definition:</b> <a href="state_8F90_source.html#l00002">state.F90:2</a></div></div>
<div class="ttc" id="anamespacepetsc__solver__mod_html_a451a0b7c857bd1c9a88afcb53784952a"><div class="ttname"><a href="namespacepetsc__solver__mod.html#a451a0b7c857bd1c9a88afcb53784952a">petsc_solver_mod::petsc_solver_get_descriptor</a></div><div class="ttdeci">type(component_descriptor_type) function, public petsc_solver_get_descriptor()</div><div class="ttdoc">Provides the descriptor back to the caller and is used in component registration.</div><div class="ttdef"><b>Definition:</b> <a href="petsc__solver_8F90_source.html#l00043">petsc_solver.F90:44</a></div></div>
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="http://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.8.20
</small></address>
</body>
</html>
